{% extends "base.html" %}
{% block page_title %}Security Audit Log{% endblock %}
{% block content %}
<p class="text-muted">View security-relevant events for compliance and investigation purposes.</p>

<!-- Filters -->
<div class="card mb-4">
  <div class="card-body">
    <form method="get" class="row g-3">
      <div class="col-md-3">
        <label class="form-label">Event Type</label>
        <select name="event_type" class="form-select">
          <option value="">All Events</option>
          {% for et in event_types %}
          <option value="{{ et.event_type }}" {% if et.event_type == filter_event_type %}selected{% endif %}>
            {{ et.event_type }}
          </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Username</label>
        <input type="text" name="username" class="form-control" value="{{ filter_username }}" placeholder="Search username...">
      </div>
      <div class="col-md-3">
        <label class="form-label">Time Period</label>
        <select name="days" class="form-select">
          <option value="1" {% if filter_days == 1 %}selected{% endif %}>Last 24 hours</option>
          <option value="7" {% if filter_days == 7 %}selected{% endif %}>Last 7 days</option>
          <option value="30" {% if filter_days == 30 %}selected{% endif %}>Last 30 days</option>
          <option value="90" {% if filter_days == 90 %}selected{% endif %}>Last 90 days</option>
        </select>
      </div>
      <div class="col-md-3 d-flex align-items-end">
        <button type="submit" class="btn btn-primary me-2">Filter</button>
        <a href="{{ url_for('admin_audit_log') }}" class="btn btn-outline-secondary">Reset</a>
      </div>
    </form>
  </div>
</div>

<!-- Log Table -->
<div class="card">
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-sm table-hover">
        <thead class="table-light">
          <tr>
            <th class="u-w-160">Timestamp</th>
            <th class="u-w-150">Event</th>
            <th class="u-w-120">Username</th>
            <th class="u-w-120">IP Address</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody>
          {% for log in logs %}
          <tr>
            <td class="text-muted small">{{ log.created_at }}</td>
            <td>
              {% if 'FAILED' in log.event_type or 'LOCKED' in log.event_type %}
                <span class="badge bg-danger">{{ log.event_type }}</span>
              {% elif 'SUCCESS' in log.event_type %}
                <span class="badge bg-success">{{ log.event_type }}</span>
              {% elif 'CREATED' in log.event_type or 'UPDATED' in log.event_type %}
                <span class="badge bg-info">{{ log.event_type }}</span>
              {% elif 'DELETED' in log.event_type %}
                <span class="badge bg-warning text-dark">{{ log.event_type }}</span>
              {% else %}
                <span class="badge bg-secondary">{{ log.event_type }}</span>
              {% endif %}
            </td>
            <td>{{ log.username or '-' }}</td>
            <td class="small text-muted">{{ log.ip_address or '-' }}</td>
            <td class="small">{{ log.details or '-' }}</td>
          </tr>
          {% else %}
          <tr>
            <td colspan="5" class="text-center text-muted py-4">No audit log entries found for the selected criteria.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    
    {% if logs %}
    <div class="text-muted small mt-2">Showing {{ logs|length }} entries (max 1000)</div>
    {% endif %}
  </div>
</div>

<div class="mt-3">
  <a href="{{ url_for('admin') }}" class="btn btn-outline-secondary">‚Üê Back to Admin</a>
</div>

<!-- Event Type Legend -->
<div class="card mt-4 bg-light">
  <div class="card-body">
    <h6>Event Types Legend</h6>
    <div class="row small">
      <div class="col-md-4">
        <span class="badge bg-success">LOGIN_SUCCESS</span> - Successful login<br>
        <span class="badge bg-danger">LOGIN_FAILED</span> - Failed login attempt<br>
        <span class="badge bg-danger">LOGIN_BLOCKED</span> - Login blocked (account locked)<br>
        <span class="badge bg-danger">ACCOUNT_LOCKED</span> - Account locked due to failed attempts
      </div>
      <div class="col-md-4">
        <span class="badge bg-secondary">LOGOUT</span> - User logged out<br>
        <span class="badge bg-secondary">SESSION_TIMEOUT</span> - Session expired<br>
        <span class="badge bg-info">PASSWORD_CHANGED</span> - Password changed
      </div>
      <div class="col-md-4">
        <span class="badge bg-info">USER_CREATED</span> - New user created<br>
        <span class="badge bg-info">USER_UPDATED</span> - User account updated<br>
        <span class="badge bg-warning text-dark">USER_DELETED</span> - User account deleted<br>
        <span class="badge bg-info">USER_UNLOCKED</span> - Account unlocked by admin
      </div>
    </div>
  </div>
</div>
{% endblock %}
