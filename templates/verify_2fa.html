<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Two-Factor Authentication - Scrutinise TXN</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/static/css/2fa.css" rel="stylesheet">
</head>
<body>
  <div class="auth-container">
    <div class="brand-panel">
      <img src="{{ url_for('static', filename='scrutinise-txn-logo.png') }}" alt="Scrutinise TXN">
      <h4 class="text-center">Two-Factor Authentication</h4>
      <p class="text-muted text-center">Enter the code from your authenticator app</p>
    </div>
    
    <div class="form-panel">
      <div class="auth-card">
        <div class="text-center mb-4">
          <div class="shield-icon">üõ°Ô∏è</div>
          <h4>Verify Your Identity</h4>
          <p class="text-muted">Hi <strong>{{ username }}</strong>, enter your 6-digit code</p>
        </div>
        
        {% with messages = get_flashed_messages() %}
          {% if messages %}
            <div class="alert alert-danger">{{ messages[0] }}</div>
          {% endif %}
        {% endwith %}
        
        <form method="post" id="totpForm">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="use_backup" id="useBackup" value="0">
          
          <div class="mb-4">
            <label class="form-label">Verification Code</label>
            <input type="text" 
                   name="code" 
                   id="codeInput"
                   class="form-control code-input" 
                   placeholder="000000"
                   maxlength="8"
                   autocomplete="one-time-code"
                   autofocus
                   required>
            <div class="form-text text-center" id="codeHelp">
              Enter the 6-digit code from your authenticator app
            </div>
          </div>
          
          <button type="submit" class="btn btn-primary w-100 mb-3">
            Verify
          </button>
          
          <div class="text-center">
            <button type="button" class="btn btn-link text-muted" onclick="toggleBackupMode()">
              Use backup code instead
            </button>
          </div>
        </form>
        
        <hr>
        
        <div class="text-center">
          <a href="{{ url_for('login') }}" class="text-muted small" onclick="return confirm('Cancel login?');">
            Cancel and return to login
          </a>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    let backupMode = false;
    
    function toggleBackupMode() {
      backupMode = !backupMode;
      const input = document.getElementById('codeInput');
      const help = document.getElementById('codeHelp');
      const useBackup = document.getElementById('useBackup');
      
      if (backupMode) {
        input.placeholder = 'XXXXXXXX';
        input.maxLength = 10;
        help.textContent = 'Enter one of your backup codes';
        useBackup.value = '1';
      } else {
        input.placeholder = '000000';
        input.maxLength = 8;
        help.textContent = 'Enter the 6-digit code from your authenticator app';
        useBackup.value = '0';
      }
      input.value = '';
      input.focus();
    }
    
    // Auto-submit when 6 digits entered (TOTP mode only)
    document.getElementById('codeInput').addEventListener('input', function(e) {
      const val = e.target.value.replace(/\D/g, '');
      if (!backupMode && val.length === 6) {
        document.getElementById('totpForm').submit();
      }
    });
  </script>
</body>
</html>
